<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Visualization Tool</title>
    <link rel="stylesheet" type= "text/css" href="{{ url_for('static', filename='styles/foundation.css') }}" />
    <link rel="stylesheet" type= "text/css" href="{{ url_for('static', filename='styles/app.css') }}" />
  </head>
  <body>
    <div id="full-page" class="grid-x grid-margin-x">
      <div id="nav-panel-parent" class="cell small-3">
        <div id="nav-panel" class="grid-y">
          <div id="form-section" class="cell medium-3 large-2">
            <form>
              <div id="domain">
                <label class="header">Select Domain:
                  <select>
                    <option value="" disabled selected>Select Domain</option>
                    {% for o in domain_list %}
                      {% if o %}
                        <option value="{{ o }}">{{ o }}</option>
                      {% endif %}
                    {% endfor %}
                  </select>
                </label>
              </div>
              <div id="libraries">
              </div>
              <div id="metrics">
                <label class="header">Select Metrics:</label>
                <select>
                  <option value="" selected>None</option>
                  <option value="backwards-compatibility">Backwards Compatibility</option>
                  <option value="issue-closing-time">Issue Closing Time</option>
                  <option value="issue-response-time">Issue Response Time</option>
                  <option value="last-discussed-on-so">Last Discussed on Stack Overflow</option>
                  <option value="last-modification-date">Last Modification Date</option>
                  <option value="performance">Performance</option>
                  <option value="popularity">Popularity</option>
                  <option value="release-frequency">Release Frequency</option>
                  <option value="security">Security</option>
                </select>
                <select>
                  <option value="" selected>None</option>
                  <option value="backwards-compatibility">Backwards Compatibility</option>
                  <option value="issue-closing-time">Issue Closing Time</option>
                  <option value="issue-response-time">Issue Response Time</option>
                  <option value="last-discussed-on-so">Last Discussed on Stack Overflow</option>
                  <option value="last-modification-date">Last Modification Date</option>
                  <option value="performance">Performance</option>
                  <option value="popularity">Popularity</option>
                  <option value="release-frequency">Release Frequency</option>
                  <option value="security">Security</option>
                </select>
                <select>
                  <option value="" selected>None</option>
                  <option value="backwards-compatibility">Backwards Compatibility</option>
                  <option value="issue-closing-time">Issue Closing Time</option>
                  <option value="issue-response-time">Issue Response Time</option>
                  <option value="last-discussed-on-so">Last Discussed on Stack Overflow</option>
                  <option value="last-modification-date">Last Modification Date</option>
                  <option value="performance">Performance</option>
                  <option value="popularity">Popularity</option>
                  <option value="release-frequency">Release Frequency</option>
                  <option value="security">Security</option>
                </select>
                <select>
                  <option value="" selected>None</option>
                  <option value="backwards-compatibility">Backwards Compatibility</option>
                  <option value="issue-closing-time">Issue Closing Time</option>
                  <option value="issue-response-time">Issue Response Time</option>
                  <option value="last-discussed-on-so">Last Discussed on Stack Overflow</option>
                  <option value="last-modification-date">Last Modification Date</option>
                  <option value="performance">Performance</option>
                  <option value="popularity">Popularity</option>
                  <option value="release-frequency">Release Frequency</option>
                  <option value="security">Security</option>
                </select>
              </div>
              <div id="form-button-group" class="button-group">
                <a id="save-button" class="button" disabled>SAVE</a>
                <a class="button">CANCEL</a>
              </div>
            </form>
          </div>
          <div id="history-section" class="cell">
            <label class="header">HISTORY</label>
            <button type="button" class="button" id="show-more">See More</button>
            <!-- Rough history... will need to be reworked to only show one until expanded -->
            <div style="background-color:black; height: 150px; margin: 5px;"></div>
            <div style="background-color:black; height: 150px; margin: 5px;"></div>
            <div style="background-color:black; height: 150px; margin: 5px;"></div>
            <div style="background-color:black; height: 150px; margin: 5px;"></div>
          </div>
        </div>
      </div>
      <div class="cell auto">
        <div id="empty-screen">
          <h1>WELCOME TO OUR DATA VIZ APP</h1>
          <p>Steps or something like that will go here</p>
        </div>
        <div id="visualizations" class="flex-grid-wrapper">
          <div class="flex-grid">
            <div id="viz1" class="visualization">
              <embed id="chart1" type="image/svg+xml" src="" />
            </div>
            <div id="viz2" class="visualization">
              <embed id="chart2" type="image/svg+xml" src="" />
            </div>
            <div id="viz3" class="visualization">
              <embed id="chart3" type="image/svg+xml" src="" />
            </div>
            <div id="viz4" class="visualization">
              <embed id="chart4" type="image/svg+xml" src="" />
            </div>
          </div>
        </div>

        <div class="option-menu" style="display: none;">
          <div id="viz-options-button-wrapper">
            <div id="viz-options-button-group" class="button-group">
              <a class="button">1</a>
              <a class="button">2</a>
              <a class="button">3</a>
              <a class="button">4</a>
            </div>
          </div>
          <div id="option-menu-button-group" class="button-group">
            <a class="button">APPLY CHANGES</a>
            <a class="button">CANCEL</a>
          </div>
        </div>
      </div>
    </div>

    <script src="{{ url_for('static', filename='js/jquery.js') }}"></script>
    <script src="{{ url_for('static', filename='js/what-input.js') }}"></script>
    <script src="{{ url_for('static', filename='js/foundation.min.js') }}"></script>

    <script>
      $(document).foundation();

      $("#save-button").click(function() {
        if(!$(this).attr('disabled')) {
          var data = {}
          var selected_domain = $("#domain :selected")
          var selected_libraries = $("#libraries :checked")
          var selected_metrics = $("#metrics :selected")

          data.domain = selected_domain["0"].textContent
          data.libraries = []
          for(var i = 0; i < selected_libraries.length; ++i) {
            data.libraries.push(selected_libraries[i].id)
          }
          data.metrics = []
          for(var i = 0; i < selected_metrics.length; ++i) {
            if(selected_metrics[i].textContent != "None") {
              data.metrics.push(selected_metrics[i].textContent)
            }
          }

          $.ajax({
           type: "POST",
           contentType: 'application/json',
           url: "/generate_chart",
           data: JSON.stringify(data),
           dataType: 'json'
          }).done(function(data)  {
            for(var i = 1; i < data.length + 1; ++i) {
              $("#chart" + i).attr("src", data[i - 1]);
              $("#chart" + i).css({"display":"inline-block"});
            }
            for(var i = data.length + 1; i <= 4; ++i) {
              $("#viz" + i).css({"display":"none"});
            }
          }).fail(function(xhr, status, error) {
            console.log(error);
          });
        }
      });

      $('#domain').on('change', function (e) {
        var optionSelected = $("option:selected", this);
        var valueSelected = $("option:selected")["0"].value;
        var library_list = {{ domain_list|tojson }}[valueSelected];

        // empty #libraries and append all library checkboxes
        $("#libraries").empty()
        $("#libraries").append("<label class=\"header\">Select Libraries:</label>");
        $("#libraries").append("<label for=\"select_all\" style=\"margin-bottom:5px;font-style:italic\"><div><input id=\"select_all\" type=\"checkbox\" checked>Select All</div></label>");
        for(var i = 0; i < library_list.length; ++i) {
          $("#libraries").append(
            "<label for=\"" + library_list[i] +"\">" +
              "<div>" +
                "<input id=\"" + library_list[i] + "\" type=\"checkbox\" checked>" +
                  library_list[i] +
              "</div>" +
            "</label>");
        }

        $("#select_all").on('change', function() {
          var checkboxes = $("#libraries").find(':checkbox');
          var is_checked = $(this).is(':checked');
          checkboxes.prop('checked', is_checked);
        });

        $(':checkbox').on('change', function() {
          if($(this)["0"].id != "select_all") {
            var checkboxes = $("#libraries").find(':checkbox');
            var checked_checkboxes = $('#libraries').find('input:checked');
            if(checkboxes.length != checked_checkboxes.length) {
              $("#select_all").prop('checked', false);
            }
          }
        });

        var selected_libraries = $("#libraries :checked");
        var metrics = $("#metrics :selected");
        var selected_metrics = [];
        for(var i = 0; i < metrics.length; ++i) {
          if(metrics[i].innerText != "None") {
            selected_metrics.push(metrics[i]);
          }
        }
        if(selected_libraries.length != 0 && selected_metrics.length != 0) {
          $('#save-button').prop('disabled', false);
        } else {
          $('#save-button').prop('disabled', true);
        }
      });

      $("#libraries").on('change', function(e) {
        var selected_libraries = $("#libraries :checked");
        var metrics = $("#metrics :selected");
        var selected_metrics = [];
        for(var i = 0; i < metrics.length; ++i) {
          if(metrics[i].innerText != "None") {
            selected_metrics.push(metrics[i]);
          }
        }
        if(selected_libraries.length != 0 && selected_metrics.length != 0) {
          $('#save-button').prop('disabled', false);
        } else {
          $('#save-button').prop('disabled', true);
        }
      });

      $("#metrics").on('change', function(e) {
        var selected_libraries = $("#libraries :checked");
        var metrics = $("#metrics :selected");
        var selected_metrics = [];
        for(var i = 0; i < metrics.length; ++i) {
          if(metrics[i].innerText != "None") {
            selected_metrics.push(metrics[i]);
          }
        }
        if(selected_libraries.length != 0 && selected_metrics.length != 0) {
          $('#save-button').prop('disabled', false);
        } else {
          $('#save-button').prop('disabled', true);
        }
      });

      $("#show-more").click(function() {
        if (!$("#history-section").hasClass("expanded")){
           $("#history-section").animate({height: '100%',},"slow");
           $("#history-section").addClass("expanded");
           $("#show-more")["0"].textContent = "Show Less";
        }
        else {
           $("#history-section").animate({height: '200px',},"slow");
           $("#history-section").removeClass("expanded");
           $("#show-more")["0"].textContent = "Show More";
        }
      });
    </script>
  </body>
</html>
